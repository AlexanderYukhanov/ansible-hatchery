- name: Prepare random number
  set_fact:
    random_postfix: "{{ 1000 | random }}"
  run_once: yes

- name: Create instance of Application Gateway -- check mode
  azure_rm_applicationgateway:
    resource_group: "{{ resource_group }}"
    name: "appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}"
    sku:
      name: Standard_Small
      tier: Standard
      capacity: 2
    gateway_ip_configurations:
      - name: app_gateway_ip_config
        subnet:
          id: /subscriptions/685ba005-af8d-4b04-8f16-a7bf38b2eb5a/resourceGroups/zims-rg1/providers/Microsoft.Network/virtualNetworks/sample-vnet/subnets/sample-subnet
    frontend_ip_configurations:
      - name: sample_gateway_frontend_ip_config
        subnet:
          id: /subscriptions/685ba005-af8d-4b04-8f16-a7bf38b2eb5a/resourceGroups/zims-rg1/providers/Microsoft.Network/virtualNetworks/sample-vnet/subnets/sample-subnet
    frontend_ports:
      - name: ag_frontent_port
        port: 90
    backend_address_pools:
      - name: test_backend_address_pool
        backend_addresses:
          - ip_address: 10.0.0.4
          - ip_address: 10.0.0.5
    backend_http_settings_collection:
      - name: sample_appgateway_http_settings
        port: 80
        protocol: Http
        cookie_based_affinity: Enabled
    http_listeners:
      - name: sample_http_listener
        frontend_ip_configuration:
          id: "/subscriptions/685ba005-af8d-4b04-8f16-a7bf38b2eb5a/resourceGroups/zims-rg1/providers/Microsoft.Network/applicationGateways/appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}/frontendIPConfigurations/sample_gateway_frontend_ip_config"
        frontend_port:
          id:  "/subscriptions/685ba005-af8d-4b04-8f16-a7bf38b2eb5a/resourceGroups/zims-rg1/providers/Microsoft.Network/applicationGateways/appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}/frontendPorts/ag_frontend_port"
#        protocol: Http
#        ssl_certificate: "None"
    request_routing_rules:
      - name: rule1
        rule_type: Basic
        http_listener:
          id: "/subscriptions/685ba005-af8d-4b04-8f16-a7bf38b2eb5a/resourceGroups/zims-rg1/providers/Microsoft.Network/applicationGateways/appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}/httpListeners/sample_http_listener"
        backend_address_pool:
          id: "/subscriptions/685ba005-af8d-4b04-8f16-a7bf38b2eb5a/resourceGroups/zims-rg1/providers/Microsoft.Network/applicationGateways/appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}/backendAddressPools/test_backend_address_pool"
        backend_http_settings:
          id: "/subscriptions/685ba005-af8d-4b04-8f16-a7bf38b2eb5a/resourceGroups/zims-rg1/providers/Microsoft.Network/applicationGateways/appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}/backendHttpSettingsCollection/sample_appgateway_http_settings"

- name: Assert the resource instance is well created
  assert:
    that:
      - output.changed

- name: Create instance of Application Gateway
  azure_rm_applicationgateway:
    resource_group: "{{ resource_group }}"
    name: "appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}"
    ssl_policy:
      disabled_ssl_protocols:
        - XXXX - list of values -- not implemented str
      cipher_suites:
        - XXXX - list of values -- not implemented str
    gateway_ip_configurations:
    authentication_certificates:
    ssl_certificates:
    frontend_ip_configurations:
    frontend_ports:
    probes:
      - match:
          status_codes:
            - XXXX - list of values -- not implemented str
    backend_address_pools:
      - backend_ip_configurations:
          - application_gateway_backend_address_pools:
              - backend_ip_configurations:
                  - application_gateway_backend_address_pools:
                    load_balancer_backend_address_pools:
                    load_balancer_inbound_nat_rules:
                    application_security_groups:
                backend_addresses:
            load_balancer_backend_address_pools:
            load_balancer_inbound_nat_rules:
            subnet:
              network_security_group:
                security_rules:
                default_security_rules:
              route_table:
                routes:
              service_endpoints:
                - locations:
                    - XXXX - list of values -- not implemented str
              resource_navigation_links:
            public_ip_address:
              zones:
                - XXXX - list of values -- not implemented str
            application_security_groups:
        backend_addresses:
    backend_http_settings_collection:
      - authentication_certificates:
    http_listeners:
    url_path_maps:
      - path_rules:
          - paths:
              - XXXX - list of values -- not implemented str
    request_routing_rules:
    redirect_configurations:
      - request_routing_rules:
        url_path_maps:
        path_rules:
    web_application_firewall_configuration:
      disabled_rule_groups:
        - rules:
            - XXXX - list of values -- not implemented int
  register: output
- name: Assert the resource instance is well created
  assert:
    that:
      - output.changed

- name: Create again instance of Application Gateway
  azure_rm_applicationgateway:
    resource_group: "{{ resource_group }}"
    name: "appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}"
    ssl_policy:
      disabled_ssl_protocols:
        - XXXX - list of values -- not implemented str
      cipher_suites:
        - XXXX - list of values -- not implemented str
    gateway_ip_configurations:
    authentication_certificates:
    ssl_certificates:
    frontend_ip_configurations:
    frontend_ports:
    probes:
      - match:
          status_codes:
            - XXXX - list of values -- not implemented str
    backend_address_pools:
      - backend_ip_configurations:
          - application_gateway_backend_address_pools:
              - backend_ip_configurations:
                  - application_gateway_backend_address_pools:
                    load_balancer_backend_address_pools:
                    load_balancer_inbound_nat_rules:
                    application_security_groups:
                backend_addresses:
            load_balancer_backend_address_pools:
            load_balancer_inbound_nat_rules:
            subnet:
              network_security_group:
                security_rules:
                default_security_rules:
              route_table:
                routes:
              service_endpoints:
                - locations:
                    - XXXX - list of values -- not implemented str
              resource_navigation_links:
            public_ip_address:
              zones:
                - XXXX - list of values -- not implemented str
            application_security_groups:
        backend_addresses:
    backend_http_settings_collection:
      - authentication_certificates:
    http_listeners:
    url_path_maps:
      - path_rules:
          - paths:
              - XXXX - list of values -- not implemented str
    request_routing_rules:
    redirect_configurations:
      - request_routing_rules:
        url_path_maps:
        path_rules:
    web_application_firewall_configuration:
      disabled_rule_groups:
        - rules:
            - XXXX - list of values -- not implemented int
  register: output
- name: Assert the state has not changed
  assert:
    that:
      - output.changed == false

- name: Delete instance of Application Gateway -- check mode
  azure_rm_applicationgateway:
    resource_group: "{{ resource_group }}"
    name: "appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}"
    state: absent
  check_mode: yes
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed

- name: Delete instance of Application Gateway
  azure_rm_applicationgateway:
    resource_group: "{{ resource_group }}"
    name: "appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}"
    state: absent
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed

- name: Delete unexisting instance of Application Gateway
  azure_rm_applicationgateway:
    resource_group: "{{ resource_group }}"
    name: "appgateway{{ random_postfix }}{{ resource_group | hash('md5') | truncate(7, True, '') }}"
    state: absent
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed == false
